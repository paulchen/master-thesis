\chapter{The Weather Importer}
\label{ch:weather}

% TODO emphasize "Norwegian Meteorological Institute" and/or "yr.no"?
In previous chapters, two topics are discussed that are relevant for this chapter: Chapter \ref{ch:weather_data} digs into the details of weather services that are available via Internet, with the example of the API by the Norwegian Meteorological Institute (\emph{yr.no}) that is found to best fit the requirements found at the \thinkhome project. Chapter \ref{ch:thinkhomeweather_ontology} describes the design of the \thinkhomeweather ontology. Eventually, the ontology needs to be populated with data, i.e. individuals that comprise the current and future state of the weather at the desired location.

For that process, a standalone Java application has been developed. As its main purpose is to import weather data, it was named \emph{Weather Importer}.

At its current state of development, the Weather Importer obtains data only from yr.no in order to provide a reference implementation being both simple and functional, but it is designed to allow simple integration of other weather services that are available via Internet as well as data from local weather sensors.

\section{The data model}

The core of the Weather importer is formed by an object-oriented data model that can be found in the \texttt{model} package. This package contains classes that are to be instantiated in order to carry all data that is collected from weather sensors and services. After processing the data in a manner that makes it suitable for use within the \thinkhomeweather ontology, individuals and statements are generated and added to the ontology.

% TODO figure
The domain model in the package \texttt{model} which resembles the structure of the \thinkhomeweather ontology is depicted in the UML class diagram in figure ?.

Other than its name suggests, \texttt{OntologyClass} is an interface that is implemented by every class that corresponds to a concept (class) in the ontology. That interface defines a set of methods which are necessary to export an object's data either to individuals and statements for adding them to the ontology using \emph{Apache Jena} or to a representation of the individuals and statements in \emph{Turtle syntax} (see section \ref{sec:importer_application} below). The methods defined by \emph{OntologyClass} are:
\begin{itemize}
  \item \texttt{createIndividuals()} creates individuals and statements holding the data that is stored in the object and adds them to the ontology. The method calls \texttt{createIndividuals()} for any objects that are connected to this object, with the exception of instances of \texttt{WeatherState} and \texttt{WeatherReport} that are linked together via the properties \texttt{previousState} and \texttt{previousReport}, respectively.
  \item \texttt{getIndividual()} returns the \texttt{Individual} object previously created by the method \texttt{createIndividuals()} that represents the main ontology individual described by the object. In some classes, due to the structure of the \thinkhomeweather ontology and the ontologies being imported, calling \texttt{createIndividuals()} will add more than one individual to the ontology, e.g. an \texttt{Instant} creates an individual of type \emph{weather:Instant} and one of type \emph{time:DateTimeDescription}. \texttt{getIndividual()} will return the \texttt{Individual} object representing the \emph{weather:Instant} individual; the corresponding \emph{time:DateTimeDescription} object can be obtained by querying the ontology for the statement having the \emph{weather:Instant} individual that has been returned as subject and the property \emph{weather:inDateTime} as predicate.
  \item \texttt{getTurtleStatements()} returns an instance of \texttt{TurtleStore} that contains a set of \texttt{TurtleStatement} objects each representing an RDF triple in \texttt{Turtle syntax}. The instance being returned contains all data that calling \texttt{createIndividuals()} would add to the ontology.
  \item \texttt{getTurtleName()} returns the qualified name of the individual represented by the object that is used in in the \texttt{TurtleStatement}s returned by calling \texttt{getTurtleStatements()}. In case \texttt{createIndividuals()} creates more than one individual, the method only yields the name of the individual returned by \texttt{getIndividual()}.
  \item \texttt{toString()} returns a textual representation of the object (for debugging purposes).
\end{itemize}

The classes inside the package \texttt{model} are:
\begin{itemize}
  \item \texttt{GeographicalPosition} resembles the concept \emph{geo:Point} in the \emph{WGS84} vocabulary that is imported into the \thinkhomeweather ontology.
  \item \texttt{TemporalEntity} corresponds to the concept \emph{time:TemporalEntity} in the \emph{OWL-Time} ontology. The are two sub-classes, \texttt{Instant} and \texttt{Interval} that resemble the concepts \emph{time:Instant} and \emph{time:Interval}, respectively.
  \item \texttt{WeatherPhenomenon} corresponds to the concept \emph{weather:WeatherPhenomenon} in the \thinkhomeweather ontology. As it is an abstract class, only its subclasses \texttt{CloudCover}, \texttt{DewPoint}, \texttt{Humidity}, \texttt{Precipitation}, \texttt{Pressure}, \texttt{SolarRadiation}, \texttt{SunPosition}, \texttt{Temperature} and \texttt{Wind} that each resemble the corresponding concept in the ontology.
  \item \texttt{WeatherReport} corresponds to the concept \emph{weather:WeatherReport}.
  \item \texttt{WeatherSource} corresponds to the concept \emph{weather:WeatherSource}. It is an abstract class and has two subclasses \texttt{SensorSource} and \texttt{ServiceSource} resembling the concepts \emph{weather:SensorSource} and \emph{weather:ServiceSource}, respectively.
  \item \texttt{WeatherState} corresponds to the concept \emph{weather:WeatherState}.
  \item \texttt{Weather} corresponds to the concept \emph{weather:Weather}.
\end{itemize}

Additionally, there is an enumeration named \texttt{WeatherConditions} having values that each correspond to the individuals predefined by the ontology for the concept \emph{weather:WeatherCondition}.

\section{The application}
\label{sec:importer_application}

The weather importer application basically performs three tasks when being launched: It reads the \thinkhomeweather ontology in \emph{RDF/XML syntax}\cite{RDF_XML} from a file on disk, modifies it in some way and and writes the modified ontology back onto disk into a new file, either in \emph{RDF/XML syntax} or in \emph{Turtle syntax} \cite{Turtle}. There are four operation modes that are covered below: \texttt{fetch}, \texttt{timestamps}, \texttt{remove} and \texttt{turtle}.

\subsection{\texttt{fetch} mode}

In \texttt{fetch} mode, the Weather importer reads the \thinkhomeweather ontology in \emph{RDF/XML syntax} from a file on disk using the \emph{Apache Jena} framework\footnote{\url{http://jena.apache.org/}{http://jena.apache.org/}} and fetches weather data for the desired location from a weather service via Internet.

For developing a reference implementation, the Weather importer obtains weather data from \emph{yr.no} as described in section \ref{subsec:weather_data_yr_no}. Any other sources for weather data, regardless whether that sources are weather sensors, Internet weather services or any combination of a set of these, can be utilized by creating a class that implements the interface \texttt{Importer}. This interface defines a single method named \texttt{fetchWeather} that returns a \texttt{Weather} object containing all weather data obtained from sensors and/or services.

By calling the method \texttt{createIndividuals()} of that \texttt{Weather} object, the weather data is added \emph{Apache Jena}'s in-memory representation of the ontology. Eventually, the modified ontology is written back to disk in \emph{RDF/XML} syntax.

% TODO reference for linear interpolation?
% TODO from Wikipedia (http://en.wikipedia.org/wiki/Linear_interpolation): Meijering, Erik (2002), "A chronology of interpolation: from ancient astronomy to modern signal and image processing", Proceedings of the IEEE 90 (3): 319â€“342, doi:10.1109/5.993400. (http://ieeexplore.ieee.org/xpl/articleDetails.jsp?arnumber=993400)
As most weather services do not provide data for arbitrary points of time, the \texttt{Weather} class provides the method \texttt{normalizeWeatherReports()}. It transforms the data encapsulated by the \texttt{Weather} object in the following ways:
\begin{itemize}
  \item Each associated \texttt{WeatherReport} object that covers a period of more than one hour is replaced by several \texttt{WeatherReport} objects, one for each hour. All associated instances of \texttt{WeatherReport} and \texttt{WeatherPhenomenon} are cloned appropriately.
  \item If there is more than one \texttt{WeatherReport} object covering the same period of time, all data from these objects will be merged into one object; the remaining objects will be discarded.
  \item In case there is no data for a period of time, it will be calculated using linear interpolation from data before and after the missing period.
  \item An instance of \texttt{SunPosition} will be associated to each instance of \texttt{WeatherState}. The sun position data is calculated using the PSA algorithm \cite{PSA_algorithm}; the C++ reference implementation of the PSA algorithm\footnote{\href{http://www.psa.es/sdg/sunpos.htm}{http://www.psa.es/sdg/sunpos.htm}} was ported to Java.
\end{itemize}

% TODO reference for arithmetic mean?
Additionally, the class \texttt{WeatherState} provides the method \texttt{mergePhenomena()} which merges all instances of \texttt{WeatherPhenomenon} of the same type that are associated to that instance of \texttt{WeatherState}. Actual merging of values takes place in the constructors of the subclasses of \texttt{WeatherPhenomenon}; all current implementations merge values by calculating the arithmetic mean of all values provided.

Both methods provide the developer of an implementation of the interface \texttt{Importer} with more flexibility on how to import weather data: An implementation is not required to provide data for each period of time, each \emph{WeatherReport} object may cover more than one hour and more than one instance of each subclass of \texttt{WeatherPhenomenon} may be associated to each instance of \texttt{WeatherState}. The latter eases merging values from several sources (e.g. an Internet weather service and a set of weather sensors).


\subsection{\texttt{timestamps} mode}

\subsection{\texttt{remove} mode}

\subsection{\texttt{turtle} mode}

% ant, jena, pellet -- tested with which versions at the time of writing?

% unit testing: junit, cobertura; test coverage - what is tested, what is omitted

% property file

% mention javadoc

% structure of the program: UML class diagram/package diagram

% modi operandi of the importer: fetch, turtle, update, remove

% turtle output (initially only for debug reasons); does not use Jena

% appendix: example turtle output

% this is only for service data; what about sensor data?
